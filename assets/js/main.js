(function(){
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const yearEl = document.getElementById('year'); if (yearEl) yearEl.textContent = new Date().getFullYear();

  // Theme toggle
  const themeToggle = document.getElementById('themeToggle');
  const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
  const storedTheme = localStorage.getItem('theme');
  const applyTheme = (t) => { if (t === 'light') document.documentElement.setAttribute('data-theme','light'); else document.documentElement.removeAttribute('data-theme'); }
  applyTheme(storedTheme || (prefersDark ? 'dark' : 'light'));
  themeToggle && themeToggle.addEventListener('click', () => { const isLight = document.documentElement.getAttribute('data-theme') === 'light'; const next = isLight ? 'dark' : 'light'; applyTheme(next); localStorage.setItem('theme', next); themeToggle.textContent = next === 'light' ? 'üåô' : '‚òÄÔ∏è'; });

  // Slow scroll
  function slowScrollTo(targetY, duration = 1000) { const startY = window.scrollY || window.pageYOffset; const distance = targetY - startY; const startTime = performance.now(); function easeInOutCubic(t){ return t<0.5 ? 4*t*t*t : 1 - Math.pow(-2*t+2,3)/2 } function step(now){ const elapsed = now - startTime; const progress = Math.min(elapsed / duration, 1); const eased = easeInOutCubic(progress); window.scrollTo(0, startY + distance * eased); if (progress < 1) requestAnimationFrame(step); } requestAnimationFrame(step); }

  // Tabs + indicator
  const links = document.querySelectorAll('.tab-link'); const indicator = document.querySelector('.tab-indicator');
  function moveIndicator(el){ if (!indicator || !el) return; const rect = el.getBoundingClientRect(); const parentRect = el.parentElement.getBoundingClientRect(); const width = rect.width; const x = rect.left - parentRect.left; indicator.style.width = `${width}px`; indicator.style.transform = `translateX(${x}px)`; }
  links.forEach(btn => { btn.addEventListener('click', (e) => { const targetSel = btn.getAttribute('data-target'); const targetEl = document.querySelector(targetSel); if (!targetEl) return; e.preventDefault(); const rect = targetEl.getBoundingClientRect(); const y = rect.top + window.pageYOffset - 64; slowScrollTo(y, 1000); moveIndicator(btn); }); });
  const sections = document.querySelectorAll('main.section, section.section'); const map = new Map(); links.forEach(l => map.set(l.getAttribute('data-target'), l));
  const sectionObserver = new IntersectionObserver((entries) => { entries.forEach(entry => { const id = '#' + entry.target.id; const link = map.get(id); if (!link) return; if (entry.isIntersecting && entry.intersectionRatio > 0.3) { document.querySelectorAll('.tab-link').forEach(b => b.classList.remove('active')); link.classList.add('active'); moveIndicator(link); // Boost neurons when entering a section
        window.NEURONS_API && window.NEURONS_API.burst(10, 0.005); } }); }, { threshold: [0.3, 0.6] });
  sections.forEach(s => sectionObserver.observe(s));

  // Reveal on scroll
  const revealEls = document.querySelectorAll('.card, .section-title, .chip'); revealEls.forEach(el => { el.style.opacity = 0; el.style.transform = 'translateY(10px)'; });
  const revealObs = new IntersectionObserver((entries) => { entries.forEach(({target, isIntersecting}) => { if (isIntersecting) { target.style.transition = 'opacity .6s ease, transform .6s ease'; target.style.opacity = 1; target.style.transform = 'translateY(0)'; revealObs.unobserve(target); } }); }, { threshold: 0.2 }); revealEls.forEach(el => revealObs.observe(el));

  // Tilt effect
  const tilts = document.querySelectorAll('[data-tilt]'); tilts.forEach(el => { const bounds = { x: 10, y: 10 }; el.addEventListener('pointermove', (e) => { const r = el.getBoundingClientRect(); const px = (e.clientX - r.left) / r.width; const py = (e.clientY - r.top) / r.height; const rx = (py - 0.5) * -bounds.y; const ry = (px - 0.5) * bounds.x; el.style.transform = `rotateX(${rx}deg) rotateY(${ry}deg)`; }); el.addEventListener('pointerleave', () => { el.style.transform = 'rotateX(0) rotateY(0)'; }); });

  // Magnetic buttons
  const magnets = document.querySelectorAll('.magnetic'); magnets.forEach(btn => { const strength = 18; btn.addEventListener('pointermove', (e) => { const r = btn.getBoundingClientRect(); const cx = r.left + r.width/2, cy = r.top + r.height/2; const dx = (e.clientX - cx)/r.width, dy = (e.clientY - cy)/r.height; btn.style.transform = `translate(${dx*strength}px, ${dy*strength}px)`; }); btn.addEventListener('pointerleave', () => { btn.style.transform = 'translate(0,0)'; }); });

  // Cursor trail
  const trail = document.getElementById('cursorTrail'); if (trail && !prefersReduced){ const ctx = trail.getContext('2d'); const particles = []; let w, h; const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1)); function resize(){ w = trail.width = trail.clientWidth * DPR; h = trail.height = trail.clientHeight * DPR; } resize(); window.addEventListener('resize', resize); function spawn(x,y){ particles.push({ x:x*DPR, y:y*DPR, r: 3*DPR, a: 0.4, vx: (Math.random()-0.5)*0.6, vy: (Math.random()-0.5)*0.6 }); } window.addEventListener('pointermove', (e)=> spawn(e.clientX, e.clientY)); function tick(){ ctx.clearRect(0,0,w,h); for (let i=particles.length-1;i>=0;i--){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.a*=0.96; p.r*=0.98; if(p.a<0.05) particles.splice(i,1); } for (const p of particles){ ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fillStyle = `rgba(20,184,166,${p.a})`; ctx.fill(); } requestAnimationFrame(tick);} tick(); }

  // Section progress
  const prog = document.querySelector('.section-progress span'); function updateProgress(){ const total = document.body.scrollHeight - window.innerHeight; const ratio = total > 0 ? window.scrollY / total : 0; prog && (prog.style.transform = `scaleY(${Math.max(0.08, ratio)})`);} window.addEventListener('scroll', updateProgress); updateProgress();

  // Command palette
  const cmd = document.getElementById('cmdPalette'), cmdInput = document.getElementById('cmdInput'), cmdList = document.getElementById('cmdList'), cmdBtn = document.querySelector('.cmd-btn'); const commands = []; document.querySelectorAll('[data-target]').forEach(el => { const sel = el.getAttribute('data-target'); const target = document.querySelector(sel); if (target){ commands.push({ label: target.id, action: ()=> target.scrollIntoView({ behavior:'smooth', block:'start' }) }); } }); commands.push({ label: 'Toggle theme', action: ()=> themeToggle.click() }); function openCmd(){ cmd.setAttribute('aria-hidden','false'); cmdInput.value=''; renderCmd(''); cmdInput.focus(); } function closeCmd(){ cmd.setAttribute('aria-hidden','true'); } function renderCmd(q){ const f = (q||'').toLowerCase(); const results = commands.filter(c => c.label.toLowerCase().includes(f)).slice(0,8); cmdList.innerHTML = results.map((c,i)=>`<li data-i="${i}">${c.label}</li>`).join(''); } cmdBtn && cmdBtn.addEventListener('click', openCmd); window.addEventListener('keydown', (e)=>{ if ((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); openCmd(); } if (e.key==='Escape') closeCmd(); }); cmdInput && cmdInput.addEventListener('input', ()=> renderCmd(cmdInput.value)); cmdList && cmdList.addEventListener('click', (e)=>{ const li = e.target.closest('li'); if(!li) return; const i = +li.getAttribute('data-i'); const f = (cmdInput.value||'').toLowerCase(); const results = commands.filter(c => c.label.toLowerCase().includes(f)).slice(0,8); results[i]?.action(); closeCmd(); });

  // Performance toggle + modes
  let VISUALS_ENABLED = true; function setPerformanceMode(mode){ const low = mode === 'low'; document.body.setAttribute('data-performance', low ? 'low' : 'high'); VISUALS_ENABLED = !low; }
  commands.push({ label: 'Performance: Low', action: ()=> setPerformanceMode('low') }); commands.push({ label: 'Performance: High', action: ()=> setPerformanceMode('high') });
  commands.push({ label: 'Mode: Hyper (more glow)', action: ()=> document.body.setAttribute('data-mode','hyper') }); commands.push({ label: 'Mode: Standard', action: ()=> document.body.removeAttribute('data-mode') });

  // ===== Starfield (3D z-depth) =====
  (function(){ const canvas = document.getElementById('starfieldCanvas'); if (!canvas || prefersReduced) return; const ctx = canvas.getContext('2d'); let w=0, h=0; const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1)); let stars=[]; function resize(){ w = canvas.width = canvas.clientWidth * DPR; h = canvas.height = canvas.clientHeight * DPR; const count = Math.round((w*h)/(2000*DPR*DPR)); stars = new Array(count).fill(0).map(()=>({ x: (Math.random()-0.5)*w, y: (Math.random()-0.5)*h, z: Math.random()*w, v: 0.6 + Math.random()*0.8 })); } resize(); window.addEventListener('resize', resize); function tick(){ if (!VISUALS_ENABLED){ requestAnimationFrame(tick); return; } ctx.clearRect(0,0,w,h); const cx = w/2, cy = h/2; for (let s of stars){ s.z -= s.v; if (s.z < 1) { s.x = (Math.random()-0.5)*w; s.y = (Math.random()-0.5)*h; s.z = w; } const k = 300 / s.z; const x = cx + s.x * k; const y = cy + s.y * k; const r = Math.max(0.6, 1.8 * (1 - s.z/w)) * DPR; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fillStyle = 'rgba(255,255,255,0.7)'; ctx.fill(); } requestAnimationFrame(tick); } tick(); })();

  // ===== Neurons animation with API (reacts to scroll) =====
  (function(){ const canvas = document.getElementById('neuronsCanvas'); if (!canvas) return; const DPR = Math.max(1, Math.min(2, window.devicePixelRatio||1)); const ctx = canvas.getContext('2d'); let w=0, h=0; let nodes=[], edges=[], pulses=[]; let running=true; function resize(){ w = canvas.width = canvas.clientWidth * DPR; h = canvas.height = canvas.clientHeight * DPR; } resize(); window.addEventListener('resize', resize); function rand(a,b){ return a + Math.random()*(b-a); } function createGraph(){ nodes = []; edges = []; pulses=[]; const count = Math.round((w*h)/(1200*DPR*DPR)); for (let i=0;i<count;i++) nodes.push({ x: rand(0,w), y: rand(0,h), r: rand(1.2,2.2) }); for (let i=0;i<nodes.length;i++){ const a = nodes[i]; let nearest = []; for (let j=0;j<nodes.length;j++) if (j!==i){ const b=nodes[j]; const d=(a.x-b.x)**2+(a.y-b.y)**2; nearest.push({j,d}); } nearest.sort((p,q)=>p.d-q.d); nearest.slice(0,3).forEach(n=> edges.push({a:i,b:n.j})); } for (let k=0;k<Math.min(20, nodes.length); k++) pulses.push({ e: Math.floor(rand(0,edges.length)), t: rand(0,1), v: rand(0.002,0.006) }); } createGraph(); function burst(n=8, speed=0.004){ for (let i=0;i<n;i++){ pulses.push({ e: Math.floor(rand(0,edges.length)), t: 0, v: speed + rand(0,0.003) }); } }
    window.NEURONS_API = { burst };
    function tick(){ if(!running || !VISUALS_ENABLED) { requestAnimationFrame(tick); return; } ctx.clearRect(0,0,w,h); ctx.lineWidth = 0.8*DPR; ctx.strokeStyle = 'rgba(160,180,255,0.12)'; ctx.beginPath(); for (const e of edges){ const a = nodes[e.a], b = nodes[e.b]; ctx.moveTo(a.x, a.y); ctx.lineTo(b.x, b.y); } ctx.stroke(); for (const n of nodes){ ctx.beginPath(); ctx.arc(n.x, n.y, n.r, 0, Math.PI*2); ctx.fillStyle = 'rgba(94,234,212,0.25)'; ctx.fill(); } for (const p of pulses){ const e = edges[p.e]; if(!e) continue; const a=nodes[e.a], b=nodes[e.b]; const x = a.x + (b.x-a.x)*p.t; const y = a.y + (b.y-a.y)*p.t; p.t += p.v; if (p.t>=1){ p.t=0; p.e = Math.floor(rand(0,edges.length)); } const g = ctx.createRadialGradient(x,y,0,x,y,8*DPR); g.addColorStop(0,'rgba(34,211,238,0.9)'); g.addColorStop(1,'rgba(34,211,238,0)'); ctx.fillStyle = g; ctx.beginPath(); ctx.arc(x,y,6*DPR,0,Math.PI*2); ctx.fill(); } requestAnimationFrame(tick);} requestAnimationFrame(tick); const observer = new MutationObserver(()=>{ running = document.body.getAttribute('data-performance')!=='low'; }); observer.observe(document.body, { attributes:true, attributeFilter:['data-performance','data-mode'] }); })();
})();
